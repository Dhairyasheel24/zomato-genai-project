import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from pathlib import Path

# Set up Streamlit page
st.set_page_config(page_title="Zomato Churn Dashboard", layout="wide")

# Title
st.title("🍽️ Zomato GenAI Churn Dashboard")

# --- Load CSV Helper ---
@st.cache_data
def load_data(relative_path):
    file_path = Path(__file__).resolve().parent.parent / 'data' / relative_path
    return pd.read_csv(file_path)

# --- Section 1: Upload Churn Dataset ---
st.sidebar.header("📁 Load Data")
churn_file = st.sidebar.file_uploader("Upload Churn Dataset (CSV)", type="csv")

if churn_file:
    df = pd.read_csv(churn_file)

    st.subheader("📊 Churn Distribution")
    fig1, ax1 = plt.subplots()
    sns.countplot(data=df, x='churned', palette='Set2', ax=ax1)
    ax1.set_title("Churned vs Not Churned Users")
    st.pyplot(fig1)

    st.subheader("📈 Days Since Last Order vs Churn")
    fig2, ax2 = plt.subplots()
    sns.boxplot(data=df, x='churned', y='last_order_days_ago', palette='Set3', ax=ax2)
    st.pyplot(fig2)

else:
    st.warning("Please upload a churn dataset to begin.")

# --- Section 2: Show Top 5 Churners ---
st.markdown("---")
st.header("🔍 Top 5 High-Risk Users (Predicted by ML)")

try:
    top5 = load_data("top5_churn_risk_users.csv")
    st.dataframe(top5, use_container_width=True)
except FileNotFoundError:
    st.error("❌ File not found: top5_churn_risk_users.csv")

# --- Section 3: GPT-Powered Offer Generator ---
st.markdown("---")
st.header("🤖 Personalized Offers Generated by GPT")

try:
    offer_df = load_data("top5_with_gpt_offers.csv")
    st.dataframe(offer_df, use_container_width=True)

    st.subheader("📝 Offer Messages")
    for _, row in offer_df.iterrows():
        st.markdown(f"""
        **👤 {row['user_id']} ({row['prob_churn']:.2%})**  
        💬 {row['gpt_offer']}
        """)
except FileNotFoundError:
    st.error("❌ GPT Offer CSV not found.")
