import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

st.set_page_config(page_title="Zomato Churn Dashboard", layout="wide")

# --- Load CSV ---
@st.cache_data
def load_data(file_path):
    return pd.read_csv(file_path)

st.title("ğŸ½ï¸ Zomato GenAI Churn Dashboard")

# --- Section 1: Load Churn Dataset ---
st.sidebar.header("ğŸ“ Load Data")
churn_file = st.sidebar.file_uploader("Upload Churn Dataset (CSV)", type="csv")

if churn_file:
    df = pd.read_csv(churn_file)

    st.subheader("ğŸ“Š Churn Distribution")
    fig1, ax1 = plt.subplots()
    sns.countplot(data=df, x='churned', palette='Set2', ax=ax1)
    ax1.set_title("Churned vs Not Churned Users")
    st.pyplot(fig1)

    st.subheader("ğŸ“ˆ Days Since Last Order vs Churn")
    fig2, ax2 = plt.subplots()
    sns.boxplot(data=df, x='churned', y='last_order_days_ago', palette='Set3', ax=ax2)
    st.pyplot(fig2)

else:
    st.warning("Please upload a churn dataset to begin.")

# --- Section 2: Show Top 5 Churners ---
st.markdown("---")
st.header("ğŸ” Top 5 High-Risk Users (Predicted by ML)")

try:
    top5 = load_data("../data/top5_churn_risk_users.csv")
    st.dataframe(top5, use_container_width=True)
except FileNotFoundError:
    st.error("âŒ File not found: top5_churn_risk_users.csv")

# --- Section 3: GPT-Powered Offer Generator ---
st.markdown("---")
st.header("ğŸ¤– Personalized Offers Generated by GPT")

try:
    offer_df = load_data("../data/top5_with_gpt_offers.csv")
    st.dataframe(offer_df, use_container_width=True)

    # Optionally show formatted messages
    st.subheader("ğŸ“ Offer Messages")
    for _, row in offer_df.iterrows():
        st.markdown(f"""
        **ğŸ‘¤ {row['user_id']} ({row['prob_churn']:.2%})**  
        ğŸ’¬ {row['gpt_offer']}
        """)
except FileNotFoundError:
    st.error("âŒ GPT Offer CSV not found.")
